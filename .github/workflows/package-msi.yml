name: Package MSI

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  msi:
    name: MSI (windows-amd64)
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@nightly
      - uses: taiki-e/install-action@just

      - name: Install packaging tools
        run: just install-packaging-tools msi

      - name: Download release binaries
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: just download-release ${{ github.event.workflow_run.head_branch }} windows-amd64

      - name: Package MSI
        run: just package-msi

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ github.event.workflow_run.head_branch }} pet-*.msi
